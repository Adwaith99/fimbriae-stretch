# Resubmitting Incomplete SMD Runs

## Quick Start

### Cancel GPU jobs and resubmit to CPU:
```bash
# 1. Cancel all GPU pulls jobs
scancel -n "smd:*"   # or scancel -u $USER to cancel all your jobs

# 2. Resubmit incomplete runs to CPU nodes
make smd-submit-new-cpu
```

---

## What Gets Resubmitted?

**By default (`USE_LEDGER=0`):**
- ✅ All runs **without** "Finished mdrun" in `pull.log`
- ✅ Runs that failed, timed out, or never started
- ✅ Runs that are in the ledger but not done
- ❌ Skips only truly completed runs

**With ledger blocking (`USE_LEDGER=1`):**
```bash
USE_LEDGER=1 make smd-submit-new-cpu
```
- ✅ All runs not in `smd_submitted.csv` and not completed
- ❌ Skips runs in ledger (assumes still running/queued)
- ❌ Skips completed runs

---

## Scenarios

### Scenario 1: GPU jobs queued but you want CPU instead
```bash
scancel -n "smd:*"              # Cancel GPU jobs
make smd-submit-new-cpu         # Resubmit to CPU
```

### Scenario 2: Some runs failed, want to retry
```bash
make smd-submit-new             # Resubmit failed runs (GPU)
# or
make smd-submit-new-cpu         # Resubmit failed runs (CPU)
```

### Scenario 3: Clean ledger of completed runs
```bash
make smd-clean-ledger           # Remove completed from ledger
make smd-submit-new             # Submit anything not done
```

### Scenario 4: Force resubmit everything not completed
```bash
# Just run without canceling (will create duplicate jobs if already running!)
make smd-submit-new-cpu
```

---

## Files

- **`manifests/smd_manifest.csv`** - Full list of all runs (generated by `make smd-manifest`)
- **`manifests/smd_submitted.csv`** - Ledger of submitted runs (optional, informational)
- **`smd/<system>/<variant>/v<speed>/rep<N>/<start_id>/pull.log`** - Check for "Finished mdrun"

---

## How Completion is Detected

A run is **completed** if:
1. `pull.xtc` exists
2. `pull.log` exists
3. `pull.log` contains "Finished mdrun"

Anything else = incomplete/failed = will be resubmitted.

---

## GPU vs CPU Mode

**GPU (default):**
```bash
make smd-submit-new
```
- Uses `--gres=gpu:<spec>` from config
- Runs `gmx mdrun -v -deffnm pull`

**CPU:**
```bash
make smd-submit-new-cpu
```
- Uses `--nodes`, `--ntasks-per-node` from config
- Runs `srun gmx_mpi mdrun -v -deffnm pull`

---

## Advanced: Manual Control

```bash
# See what would be submitted (dry run)
SLURM_TEST_ONLY=1 make smd-submit-new

# Use ledger to block resubmissions
USE_LEDGER=1 make smd-submit-new

# Custom safety factor for walltime
SMD_TIME_SAFETY_FACTOR=1.5 make smd-submit-new
```

---

## Troubleshooting

**Q: Jobs are resubmitting even though they're running!**  
A: Cancel them first with `scancel`, or use `USE_LEDGER=1` to respect the ledger.

**Q: Completed runs are being resubmitted!**  
A: Check if `pull.log` contains "Finished mdrun". If not, GROMACS may have crashed.

**Q: Want to track what's completed separately?**  
A: Run `make smd-clean-ledger` to remove completed runs from ledger, then check `smd_submitted.csv` for incomplete/active runs.
